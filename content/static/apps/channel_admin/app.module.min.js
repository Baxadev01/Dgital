var srbcApp=angular.module("srbcApp",["ngTouch","ngSanitize","sticky","ngAnimate","ui.bootstrap","ui.bootstrap.tpls","ui.bootstrap.position","ui.bootstrap.popover","btford.markdown"]);srbcApp.factory("httpApiInterceptor",["$q",function(a){return{response:function(b){if(b.data.code&&b.data.status==="error"){return a.reject(b.data)}return b},responseError:function(b){return a.reject(b)}}}]);srbcApp.config(["$httpProvider",function(a){a.interceptors.push("httpApiInterceptor");a.defaults.xsrfCookieName="csrftoken";a.defaults.xsrfHeaderName="X-CSRFToken";a.defaults.headers.common["X-Requested-With"]="XMLHttpRequest"}]);srbcApp.config(["$interpolateProvider",function(a){a.startSymbol("{$");a.endSymbol("$}")}]);srbcApp.controller("RootCtrl",["$scope","$http","$window","$timeout","$location",function(a,e,c,b,d){a.initiated=false;a.$root.channel=null;a.channels=[];a.show_post_preview=false;a.$root.alerts=[];a.messages=[];a.posts=[];a.selected_post=null;a.posts_filter_text="";a.new_post_tpl={is_private:false,is_posted:false,text:""};a.posts_filter_to=null;a.msgStatuses={NEW:"Неотвеченные сообщения",ANSWERED:"Отвеченные сообщения",CANCELED:"Пропущенные сообщения",REJECTED:"Отклоненные сообщения",POSTPONED:"Отложенные сообщения"};a.messagesGlobalFilter={status:"NEW"};a.postsSearchContext=function(){if(a.posts_filter_to){b.cancel(a.posts_filter_to)}a.posts_filter_to=b(function(){a.loadPosts()},300)};a.copyPostToForm=function(f){if(a.new_post.text.length){a.new_post.text+="\n"}a.new_post.text+=f.text;if(f.image_url){a.new_post.image_url=f.image_url}};a.recentPostsSearchContext=function(){if(a.posts_filter_to){b.cancel(a.posts_filter_to)}a.posts_filter_to=b(function(){a.loadRecentPosts()},300)};a.getMessagesGlobalFilterStatusText=function(){if(a.messagesGlobalFilter.status){return a.msgStatuses[a.messagesGlobalFilter.status]}else{return"Все сообщения"}};a.messages_filter={message_type:window.DEFAULT_MSG_TYPE_FILTER,text:""};a.posts_filter={is_private:false,text:""};a.new_post={};a.new_post_init=function(){a.new_post=angular.copy(a.new_post_tpl);if(sessionStorage.postDraft){a.new_post.text=sessionStorage.postDraft}};a.$root.addAlert=function(h,g,i,j){if(angular.isUndefined(g)){g="default"}if(angular.isUndefined(i)){i=0}var f={message:h,type:g,timeout:i};if(angular.isDefined(j)){f.callback=j}a.$root.alerts.push(f);console.log(a.$root.alerts)};a.$root.closeAlert=function(f){a.$root.alerts.splice(f,1)};a.savePostDraft=function(){sessionStorage.postDraft=a.new_post.text};a.respondWithExisting=function(){var f=[];for(var g in a.messages){if(a.messages[g].is_selected){f.push(a.messages[g].id)}}if(!f.length&&!a.new_post.additional_recipients){return}if(!a.selected_post){return}e.put("/api/v1/tg/messages/",{post_id:a.selected_post.id,channel_id:a.$root.channel.id,respond_to:f,additional_recipients:a.new_post.additional_recipients}).then(function(h){console.log(h);a.$root.addAlert("Ответ был отправлен","info",5000);a.new_post.additional_recipients=[];a.loadUsersMessages()},function(h){console.log(h);var i="Ошибка ответа на сообщение";if(h.data&&h.data.error){i=h.data.error}a.$root.addAlert(i,"danger",5000)})};a.prependQuestionText=function(f){f=f.replace(/#вопрос/ig,"").replace(/([_*])/ig,"\\$1").trim();a.new_post.text="_Вопрос:_ "+f+"\n\n_Ответ:_ "+a.new_post.text};a.prependFeedbackText=function(f){f=f.replace(/#отзыв/ig,"").replace(/([_*])/ig,"\\$1").trim();a.new_post.text="#отзыв: "+f+"\n\n_Комментарий:_ "+a.new_post.text};a.prependQuote=function(f){if(f.message_type==="QUESTION"){a.prependQuestionText(f.text)}else{if(f.message_type==="FORMULA"){a.prependQuestionText(f.text)}else{if(f.message_type==="MEAL"){a.prependFeedbackText(f.text)}else{if(f.message_type==="FEEDBACK"){a.prependFeedbackText(f.text)}}}}};a.editPost=function(f){f.dirty_text=angular.copy(f.text);f.is_edit=true};a.setMessageStatusFilter=function(f){if(f!==a.messagesGlobalFilter.status){a.messagesGlobalFilter.status=f;a.loadUsersMessages()}};a.setMessageTypeFilter=function(f){if(f!==a.messagesGlobalFilter.message_type){a.messagesGlobalFilter.message_type=f}else{delete a.messagesGlobalFilter.message_type;delete a.messages_filter.message_type}a.loadUsersMessages()};a.updatePost=function(f){f.text=angular.copy(f.dirty_text);e.put("/api/v1/tg/posts/"+f.id+"/",f).then(function(i){var g=angular.copy(i.data);for(var h in a.posts){if(a.posts[h].id===g.id){a.posts[h]=g}}},function(g){console.log(g);var h="Ошибка редактирования сообщения";if(g.data&&g.data.error){h=g.data.error}a.$root.addAlert(h,"danger",5000)})};a.resetPost=function(f){f.is_edit=false};a.respondWithNew=function(){var f=[];for(var g in a.messages){if(a.messages[g].is_selected){f.push(a.messages[g].id)}}a.new_post.channel_id=a.$root.channel.id;e.post("/api/v1/tg/posts/",{post:a.new_post,respond_to:f}).then(function(h){console.log(h);a.$root.addAlert("Ответ был отправлен","info",5000);sessionStorage.postDraft="";a.new_post_init();if(f.length){a.loadUsersMessages()}a.loadPosts()},function(h){console.log(h);var i="Ошибка ответа на сообщение";if(h.data&&h.data.error){i=h.data.error}a.$root.addAlert(i,"danger",5000)})};a.setSelectedPost=function(f){console.log(f);a.selected_post=f};a.setMessageAuthorFilter=function(f){delete a.messagesGlobalFilter.status;delete a.messages_filter.status;delete a.messagesGlobalFilter.message_type;delete a.messages_filter.message_type;a.messagesGlobalFilter.author_id=f;a.messages_filter.text="";a.loadUsersMessages()};a.setMessageStatus=function(g,f){var h=angular.copy(g);h.status=f;e.put("/api/v1/tg/messages/"+g.id+"/",h).then(function(i){g.status=i.data.status},function(i){console.log(i);var j="Ошибка редактирования сообщения";if(i.data&&i.data.error){j=i.data.error}a.$root.addAlert(j,"danger",5000)})};a.setMessageType=function(f,h){var g=angular.copy(f);g.message_type=h;e.put("/api/v1/tg/messages/"+f.id+"/",g).then(function(i){f.message_type=i.data.message_type},function(i){console.log(i);var j="Ошибка редактирования сообщения";if(i.data&&i.data.error){j=i.data.error}a.$root.addAlert(j,"danger",5000)})};a.resetMessagesGlobalFilter=function(){a.messagesGlobalFilter={status:"NEW"};if(a.$root.channel){a.messagesGlobalFilter.channel_id=a.$root.channel.id}a.messages_filter={message_type:window.DEFAULT_MSG_TYPE_FILTER};a.loadUsersMessages()};a.loadUsersMessages=function(){a.$root.is_messages_loading=true;e.get("/api/v1/tg/messages/",{params:a.messagesGlobalFilter}).then(function(f){a.messages=f.data;a.$root.is_messages_loading=false},function(f){console.log(f);a.$root.is_messages_loading=false;a.$root.addAlert("Ошибка загрузки сообщений","danger",5000)})};a.getChannels=function(){e.get("/api/v1/tg/channels/",{}).then(function(f){a.channels=f.data;if(!a.$root.channel){a.setActiveChannel(a.channels[a.channels.length-1])}},function(f){console.log(f);a.$root.addAlert("Ошибка загрузки списка каналов","danger",5000)})};a.setActiveChannel=function(f){if(angular.equals(f,a.$root.channel)){return}a.$root.channel=f;a.messagesGlobalFilter.channel_id=a.$root.channel.id;a.resetMessagesGlobalFilter();a.loadUsersMessages();a.loadPosts();a.loadRecentPosts()};a.loadPosts=function(){var f={};if(a.posts_filter_text.length){f.search=a.posts_filter_text}if(a.posts_filter.is_private){f["private"]=""}else{f.channel_id=a.$root.channel.id}e.get("/api/v1/tg/posts/",{params:f}).then(function(g){a.posts=g.data},function(g){console.log(g);a.$root.addAlert("Ошибка загрузки сообщений","danger",5000)})};a.loadRecentPosts=function(){var f={};if(a.posts_filter_text.length){f.search=a.posts_filter_text}if(a.posts_filter.is_private){f["private"]=""}console.log(f);e.get("/api/v1/tg/posts/",{params:f}).then(function(g){a.recent_posts=g.data},function(g){console.log(g);a.$root.addAlert("Ошибка загрузки сообщений","danger",5000)})};a.new_post_init();a.getChannels()}]);srbcApp.controller("ConfirmModalCtrl",["$scope","$uibModalInstance",function(a,b,c){a.ok=function(){b.close(c)};a.cancel=function(){b.dismiss("cancel")}}]);Date.prototype.addDays=function(b){var a=new Date(this.valueOf());a.setDate(a.getDate()+b);return a};Date.prototype.toSQL=function(){var b=this.getMonth()+1;var a=this.getDate();return[this.getFullYear(),(b>9?"":"0")+b,(a>9?"":"0")+a].join("-")};